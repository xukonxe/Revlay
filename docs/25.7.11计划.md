# Revlay 开发计划 (2025.7.11)

这是一个根据用户反馈制定的迭代开发计划，旨在将 `revlay` 从一个简单的命令行工具，提升为一个具有优秀用户体验、高度智能化的交互式部署平台。

---

### **第一阶段：实现核心的 `rsync` 远程部署流程 (Milestone 1)**

**目标**: 实现一个稳定、可靠的非交互式远程部署命令。这是后续所有交互功能的基础。

**命令设计**:
- **开发端**: `revlay push --source <本地源目录> --dest <user@host:远程项目根目录>`
- **服务端**: `revlay deploy --from-dir <服务器上的源目录>`

**实现步骤**:
1.  **服务端能力增强**:
    - 修改 `deploy` 命令，增加 `--from-dir <路径>` 参数。
    - 当使用此参数时，部署流程将从指定的目录中移动文件来创建新版本，而不是创建一个空目录。
    - 如果不使用此参数，则保持现有逻辑（创建空目录，依赖 `hooks` 填充）。
2.  **开发端能力构建**:
    - 创建一个全新的 `push` 命令。
    - 重新引入 SSH 功能，用于建立 `rsync` 通道和执行远程命令。
    - `push` 命令内部流程：
        a. 通过 SSH 在服务器上创建一个临时的上传目录。
        b. 在开发机上执行 `rsync` 命令，将本地源文件高效同步到服务器的临时目录。
        c. `rsync` 成功后，通过 SSH 触发服务端的 `revlay deploy --from-dir <临时目录>` 命令。
        d. 将远程部署过程的日志实时流式传输回开发端。
        e. 部署结束后，清理服务器上的临时目录。

---

### **第二阶段：引入 `Bubble Tea` 并实现智能安装 (Milestone 2)**

**目标**: 提升 `push` 命令的用户体验，降低首次使用的门槛。

**实现步骤**:
1.  **环境预检**: 在 `push` 命令执行的最开始，增加“环境预检”阶段。
    - 通过 SSH 连接服务器，检查 `revlay` 是否已安装 (`command -v revlay`)。
2.  **智能安装与升级**:
    - 如果 `revlay` 不存在，触发自动安装流程。
    - 如果存在，检查版本号，并提示用户是否需要升级。
3.  **引入 `Bubble Tea`**:
    - 使用 `Bubble Tea` 库美化“预检”和“安装”过程的输出，提供清晰的步骤列表、进度条等视觉元素，提升交互体验。
    - 预设多个下载源（如 GitHub Release 和国内镜像）以保证下载成功率。

---

### **第三阶段：实现交互式应用选择 (Milestone 3)**

**目标**: 实现部署目标的交互式选择，避免手动输入冗长路径，让 `push` 命令变得像一个远程项目管理器。

**实现步骤**:
1.  **项目发现**: 在“环境预检”成功后，进入“目标选择”阶段。
    - `push` 命令的 `--dest` 参数将指向一个包含多个项目的根目录（如 `/var/www`）。
    - 程序通过 SSH `ls` 这个根目录，寻找所有包含 `revlay.yml` 的子目录，将它们识别为可部署的应用。
2.  **获取应用详情**:
    - 远程读取每个项目的 `revlay.yml` 文件或执行 `revlay status`，获取应用名称、当前版本等信息。
3.  **`Bubble Tea` 交互列表**:
    - 使用 `Bubble Tea` 的 `list` 组件，将所有可部署的应用以列表形式展示给用户。
    - 列表项包含应用名称、当前状态、路径等关键信息，方便用户选择。
4.  **最终确认**:
    - 用户通过方向键选择目标应用后，弹出一个 `Bubble Tea` 的确认框，例如：“是否要将本地目录 xx 中的文件推送到应用【xxx】？ (Y/n)”。

---

### **远期展望**

在完成以上三个核心阶段后，可以基于已有的交互框架，继续扩展更多强大的远程管理功能，例如：
- 交互式回滚 (`revlay rollback --dest ...`)
- 远程状态查看 (`revlay status --dest ...`)
- 远程项目初始化 (`revlay init --dest ...`) 