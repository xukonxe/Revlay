# Revlay 增强部署流程设计文档 (Push v2)

## 1. 核心愿景

实现 `revlay push` 命令的极致一键式部署体验。新的工作流程将足够智能，能够自动处理从环境校验、版本握手、应用初始化到最终部署的全部流程，让用户仅需一条命令即可安全、可靠地完成所有操作。

新的命令签名：
`revlay push -p <local_path> -to <user@host> -app <app_name> [flags]`

---

## 2. 端到端工作流程

当用户执行 `revlay push` 命令时，系统将按以下顺序执行自动化流程：

1.  **本地环境预检**:
    *   检查本地系统是否安装了 `ssh` 和 `rsync` 客户端。
    *   若缺失，则流程终止并提供清晰的安装指引。

2.  **远程环境探测**:
    *   通过 SSH 连接到目标主机。
    *   检查远程 `revlay` 是否已安装且在 `PATH` 中。
    *   获取远程 `revlay` 的版本号。

3.  **版本兼容性握手与自动修复**:
    *   将本地与远程 `revlay` 的版本进行比较。
    *   **不兼容**: 根据预设规则（见下文），可能会强制用户升级本地 `revlay`，或自动更新远程 `revlay`。
    *   **未安装**: 自动为远程主机下载并安装 `revlay` 的最新兼容版本。

4.  **远程应用服务检查**:
    *   检查指定的应用名称 (`-app <name>`) 是否已在远程 `revlay` 中注册。
    *   若已注册，则继续。

5.  **交互式初始化引导**:
    *   若应用未注册，系统会向用户发起交互式询问，引导用户在远程主机上完成新应用服务的初始化配置。

6.  **执行部署**:
    *   压缩 `-p` 指定的本地目录。
    *   通过 `rsync` 将压缩包高效地上传到远程主机的临时目录。
    *   在远程主机上执行 `revlay deploy` 命令，完成原子化部署（解压、符号链接切换）。

---

## 3. 关键技术与设计要点

### 3.1 原子化远程安装/更新

为保证远程 `revlay` 在安装或更新过程中不被破坏，整个过程将是原子化的：

1.  **备份**: 备份远程服务器上现有的 `revlay` (若存在)。
2.  **临时下载**: 将新版本下载到临时目录 (`/tmp/revlay_new`)。
3.  **验证**: 验证下载文件的完整性和可执行性。
4.  **原子替换**: 验证成功后，通过 `mv` 命令将新版本移动到目标路径 (`/usr/local/bin` 或用户指定路径)。这是一个原子操作。
5.  **回滚**: 若过程中任何一步失败，则恢复备份，确保远程环境状态不变。

### 3.2 严格的版本兼容策略

使用语义化版本（Major.Minor.Patch）进行比较：

*   **主版本号 (Major) 不同**: **绝对不兼容**。必须强制用户升级版本较低的一方。
*   **次版本号 (Minor) 不同 (远程 > 本地)**: **不兼容**。提示用户必须升级本地 `revlay` 才能继续。
*   **次版本号 (Minor) 不同 (本地 > 远程)**: **可修复**。自动为用户更新远程的 `revlay`。
*   **补丁号 (Patch) 不同**: **兼容**。打印建议更新的提示，但允许继续操作。

### 3.3 极致的用户体验

*   **可视化反馈**: 部署的每一步都将通过 `pterm` 的微调器（Spinners）和前缀打印机提供清晰的、实时的状态反馈。
*   **输出控制**: 提供 `--verbose` 模式输出详细的底层日志（SSH, rsync），以及 `--quiet` 模式屏蔽大部分输出，仅在出错时显示信息。
*   **智能错误提示**: 针对 SSH 认证失败、网络超时、权限不足等常见问题，提供人性化的错误诊断和解决方案建议。

### 3.4 灵活的 SSH 配置

为了适应非标准服务器环境，`push` 命令将支持高级 SSH 参数：

*   `--ssh-port <port>`: 指定非标准的 SSH 端口。
*   `--ssh-key <path_to_key>` (或 `-i`): 指定用于认证的私钥文件。

### 3.5 核心逻辑解耦

为支持未来的 Web UI 或其他客户端，核心业务逻辑将被抽离到 `internal/core` 包中，与 `internal/cli` 的命令行展示代码分离。CLI 将作为核心逻辑的一个“薄客户端”，负责调用并格式化输出。

---

## 4. 潜在风险与应对策略

*   **外部依赖**: `ssh` 和 `rsync` 是前置依赖。
    *   **应对**: 通过启动时预检来解决，第一时间告知用户。

*   **远程写权限**: 用户可能没有 `/usr/local/bin` 的写权限。
    *   **应对**: 优先尝试 `/usr/local/bin`，失败后回退到用户主目录下的 `~/bin` 或 `~/.local/bin`。未来可增加 `--install-path` 参数让用户手动指定。

*   **SSH 连接问题**:
    *   **应对**: 通过明确的文档、高级 SSH 参数以及更智能的错误诊断来缓解。 